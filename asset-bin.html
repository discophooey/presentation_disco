<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Work Folder - Presentation Disco</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0a0a0a; 
    color: #e0e0e0;
    min-height: 100vh;
}

.header {
    background: #1a1a1a;
    border-bottom: 1px solid #2a2a2a;
    padding: 12px 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header h1 {
    font-size: 16px;
    color: #4a9eff;
}

.header button {
    padding: 6px 12px;
    background: #2a2a2a;
    border: 1px solid #3a3a3a;
    border-radius: 4px;
    color: #e0e0e0;
    cursor: pointer;
    font-size: 12px;
}

.header button:hover {
    background: #3a3a3a;
}

/* Setup screen */
.setup-screen {
    padding: 40px 20px;
    max-width: 500px;
    margin: 0 auto;
}

.setup-screen h2 {
    font-size: 18px;
    margin-bottom: 20px;
    color: #fff;
}

.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    font-size: 12px;
    color: #888;
    margin-bottom: 6px;
}

.form-group select,
.form-group input {
    width: 100%;
    padding: 10px;
    background: #1a1a1a;
    border: 1px solid #2a2a2a;
    border-radius: 6px;
    color: #e0e0e0;
    font-size: 14px;
}

.form-group input::placeholder {
    color: #555;
}

.hint {
    font-size: 11px;
    color: #666;
    margin-top: 4px;
}

.btn-row {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
}

.btn-primary {
    background: #4a9eff;
    color: #000;
}

.btn-primary:hover {
    background: #3a8eef;
}

.btn-secondary {
    background: #2a2a2a;
    color: #e0e0e0;
}

.btn-secondary:hover {
    background: #3a3a3a;
}

/* Browser screen */
.browser-screen {
    display: none;
    height: calc(100vh - 50px);
    display: flex;
    flex-direction: column;
}

.breadcrumb {
    padding: 10px 16px;
    background: #151515;
    border-bottom: 1px solid #2a2a2a;
    font-size: 12px;
    color: #888;
}

.breadcrumb a {
    color: #4a9eff;
    text-decoration: none;
}

.breadcrumb a:hover {
    text-decoration: underline;
}

.breadcrumb span {
    margin: 0 6px;
    color: #444;
}

.asset-grid {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
    align-content: start;
}

.asset-item {
    background: #1a1a1a;
    border: 1px solid #2a2a2a;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    transition: border-color 0.2s, transform 0.2s;
}

.asset-item:hover {
    border-color: #4a9eff;
    transform: translateY(-2px);
}

.asset-item.folder {
    background: #1a1a1a;
}

.asset-thumb {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
    background: #0a0a0a;
    display: flex;
    align-items: center;
    justify-content: center;
}

.asset-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.asset-thumb.folder-icon {
    font-size: 48px;
    color: #4a9eff;
}

.asset-name {
    padding: 8px;
    font-size: 11px;
    color: #aaa;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: center;
}

/* Loading & empty states */
.loading, .empty {
    padding: 60px 20px;
    text-align: center;
    color: #666;
}

.loading::before {
    content: '‚è≥';
    display: block;
    font-size: 32px;
    margin-bottom: 12px;
}

.empty::before {
    content: 'üì≠';
    display: block;
    font-size: 32px;
    margin-bottom: 12px;
}

/* Toast notification */
.toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: #4a9eff;
    color: #000;
    padding: 12px 24px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    opacity: 0;
    transition: transform 0.3s, opacity 0.3s;
}

.toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

/* Hidden */
.hidden { display: none !important; }

/* Disco Modal */
.disco-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:99999;display:none;align-items:center;justify-content:center;opacity:0;transition:opacity 0.2s;pointer-events:none;font-family:-apple-system,BlinkMacSystemFont,sans-serif}
.disco-modal-overlay.active{display:flex;opacity:1;pointer-events:auto}
.disco-modal{background:#1e1e24;border-radius:12px;padding:24px;max-width:360px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.5);transform:scale(0.95);transition:transform 0.2s}
.disco-modal-overlay.active .disco-modal{transform:scale(1)}
.disco-modal-title{color:#4a9eff;font-size:14px;font-weight:600;margin-bottom:12px}
.disco-modal-msg{color:#ccc;font-size:14px;line-height:1.5;margin-bottom:20px;white-space:pre-line}
.disco-modal-btns{display:flex;gap:8px;justify-content:flex-end}
.disco-modal-btns button{padding:8px 18px;border:none;border-radius:6px;font-size:13px;font-weight:500;cursor:pointer;transition:background 0.2s}
.disco-modal-btns .disco-btn-primary{background:#4a9eff;color:#fff}
.disco-modal-btns .disco-btn-primary:hover{background:#3a8eef}
.disco-modal-btns .disco-btn-secondary{background:#2a2a34;color:#aaa}
.disco-modal-btns .disco-btn-secondary:hover{background:#3a3a44;color:#ccc}
</style>
</head>
<body>

<div class="header">
    <h1>üìÅ Work Folder</h1>
    <button onclick="showSetup()">‚öôÔ∏è Settings</button>
</div>

<div id="setupScreen" class="setup-screen">
    <h2>Connect Work Folder</h2>
    
    <div class="form-group">
        <label>Source</label>
        <select id="sourceType" onchange="updateSourceUI()">
            <option value="github">GitHub (Public Repo)</option>
            <option value="custom">Custom Server</option>
        </select>
    </div>
    
    <div class="form-group" id="githubFields">
        <label>GitHub Folder URL</label>
        <input type="url" id="githubUrl" placeholder="https://github.com/user/repo/tree/main/assets">
        <div class="hint">Paste a public GitHub folder URL. Example: https://github.com/username/repo/tree/main/images</div>
    </div>
    
    <div class="form-group hidden" id="customFields">
        <label>Server URL</label>
        <input type="url" id="customUrl" placeholder="https://myserver.com/assets">
        <div class="hint">URL to folder with directory listing enabled, or containing an assets.json file</div>
    </div>
    
    <div class="btn-row">
        <button class="btn btn-primary" onclick="connect()">Connect</button>
        <button class="btn btn-secondary" onclick="disconnect()">Disconnect</button>
    </div>
</div>

<div id="browserScreen" class="browser-screen hidden">
    <div class="breadcrumb" id="breadcrumb">
        <a href="#" onclick="navigateTo('')">root</a>
    </div>
    <div class="asset-grid" id="assetGrid">
        <div class="loading">Loading assets...</div>
    </div>
</div>

<div class="toast" id="toast">URL copied to clipboard!</div>

<script>
let config = {
    type: null,
    url: null,
    owner: null,
    repo: null,
    branch: null,
    basePath: null
};

let currentPath = '';

// Load saved config
function loadConfig() {
    const saved = localStorage.getItem('disco_workfolder');
    if (saved) {
        config = JSON.parse(saved);
        document.getElementById('sourceType').value = config.type || 'github';
        if (config.type === 'github' && config.url) {
            document.getElementById('githubUrl').value = config.url;
        } else if (config.type === 'custom' && config.url) {
            document.getElementById('customUrl').value = config.url;
        }
        updateSourceUI();
        
        if (config.type && config.url) {
            showBrowser();
            loadFolder('');
        }
    }
}

// Save config
function saveConfig() {
    localStorage.setItem('disco_workfolder', JSON.stringify(config));
}

// Update UI based on source type
function updateSourceUI() {
    const type = document.getElementById('sourceType').value;
    document.getElementById('githubFields').classList.toggle('hidden', type !== 'github');
    document.getElementById('customFields').classList.toggle('hidden', type !== 'custom');
}

// Parse GitHub URL
function parseGitHubUrl(url) {
    // https://github.com/owner/repo/tree/branch/path/to/folder
    const match = url.match(/github\.com\/([^\/]+)\/([^\/]+)\/tree\/([^\/]+)(?:\/(.*))?/);
    if (match) {
        return {
            owner: match[1],
            repo: match[2],
            branch: match[3],
            path: match[4] || ''
        };
    }
    return null;
}

// Connect to folder
function connect() {
    const type = document.getElementById('sourceType').value;
    
    if (type === 'github') {
        const url = document.getElementById('githubUrl').value.trim();
        if (!url) {
            discoAlert('Please enter a GitHub folder URL');
            return;
        }
        
        const parsed = parseGitHubUrl(url);
        if (!parsed) {
            discoAlert('Invalid GitHub URL. Please use format:\nhttps://github.com/user/repo/tree/branch/folder');
            return;
        }
        
        config = {
            type: 'github',
            url: url,
            owner: parsed.owner,
            repo: parsed.repo,
            branch: parsed.branch,
            basePath: parsed.path
        };
    } else {
        const url = document.getElementById('customUrl').value.trim();
        if (!url) {
            discoAlert('Please enter a server URL');
            return;
        }
        
        config = {
            type: 'custom',
            url: url.replace(/\/$/, '')
        };
    }
    
    saveConfig();
    showBrowser();
    loadFolder('');
}

// Disconnect
function disconnect() {
    config = { type: null, url: null };
    localStorage.removeItem('disco_workfolder');
    showSetup();
}

// Show screens
function showSetup() {
    document.getElementById('setupScreen').classList.remove('hidden');
    document.getElementById('browserScreen').classList.add('hidden');
}

function showBrowser() {
    document.getElementById('setupScreen').classList.add('hidden');
    document.getElementById('browserScreen').classList.remove('hidden');
}

// Load folder contents
async function loadFolder(path) {
    currentPath = path;
    const grid = document.getElementById('assetGrid');
    grid.innerHTML = '<div class="loading">Loading assets...</div>';
    
    updateBreadcrumb(path);
    
    try {
        let items = [];
        
        if (config.type === 'github') {
            items = await loadGitHubFolder(path);
        } else {
            items = await loadCustomFolder(path);
        }
        
        renderGrid(items);
    } catch (err) {
        console.error(err);
        grid.innerHTML = '<div class="empty">Failed to load folder.<br>' + err.message + '</div>';
    }
}

// Load GitHub folder via API
async function loadGitHubFolder(subPath) {
    const fullPath = config.basePath ? (subPath ? config.basePath + '/' + subPath : config.basePath) : subPath;
    const apiUrl = `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${fullPath}?ref=${config.branch}`;
    
    const response = await fetch(apiUrl);
    if (!response.ok) {
        throw new Error('GitHub API error: ' + response.status);
    }
    
    const data = await response.json();
    
    return data.map(item => ({
        name: item.name,
        type: item.type === 'dir' ? 'folder' : 'file',
        url: item.type === 'file' ? item.download_url : null,
        path: subPath ? subPath + '/' + item.name : item.name
    })).filter(item => {
        // Only show folders and image files
        if (item.type === 'folder') return true;
        const ext = item.name.split('.').pop().toLowerCase();
        return ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(ext);
    });
}

// Load custom server folder
async function loadCustomFolder(subPath) {
    const url = subPath ? config.url + '/' + subPath : config.url;
    
    // Try assets.json first
    try {
        const jsonUrl = url + '/assets.json';
        const response = await fetch(jsonUrl);
        if (response.ok) {
            const data = await response.json();
            return data.images || data.files || data;
        }
    } catch (e) {
        // assets.json not found, try directory listing
    }
    
    // Try parsing directory listing HTML
    const response = await fetch(url);
    if (!response.ok) {
        throw new Error('Server returned ' + response.status);
    }
    
    const html = await response.text();
    const items = [];
    
    // Parse links from directory listing
    const linkRegex = /href="([^"]+)"/g;
    let match;
    while ((match = linkRegex.exec(html)) !== null) {
        const href = match[1];
        // Skip parent dir and hidden files
        if (href === '../' || href.startsWith('.') || href.startsWith('?')) continue;
        
        const isFolder = href.endsWith('/');
        const name = href.replace(/\/$/, '');
        const ext = name.split('.').pop().toLowerCase();
        
        if (isFolder || ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(ext)) {
            items.push({
                name: name,
                type: isFolder ? 'folder' : 'file',
                url: isFolder ? null : url + '/' + name,
                path: subPath ? subPath + '/' + name : name
            });
        }
    }
    
    return items;
}

// Update breadcrumb
function updateBreadcrumb(path) {
    const crumb = document.getElementById('breadcrumb');
    let html = '<a href="#" onclick="navigateTo(\'\')">root</a>';
    
    if (path) {
        const parts = path.split('/');
        let cumPath = '';
        parts.forEach((part, i) => {
            cumPath += (i > 0 ? '/' : '') + part;
            const p = cumPath;
            html += ` <span>/</span> <a href="#" onclick="navigateTo('${p}')">${part}</a>`;
        });
    }
    
    crumb.innerHTML = html;
}

// Navigate to path
function navigateTo(path) {
    loadFolder(path);
    return false;
}

// Render grid
function renderGrid(items) {
    const grid = document.getElementById('assetGrid');
    
    if (items.length === 0) {
        grid.innerHTML = '<div class="empty">No images found in this folder</div>';
        return;
    }
    
    // Sort: folders first, then files
    items.sort((a, b) => {
        if (a.type !== b.type) return a.type === 'folder' ? -1 : 1;
        return a.name.localeCompare(b.name);
    });
    
    grid.innerHTML = items.map(item => {
        if (item.type === 'folder') {
            return `
                <div class="asset-item folder" onclick="navigateTo('${item.path}')">
                    <div class="asset-thumb folder-icon">üìÅ</div>
                    <div class="asset-name">${item.name}</div>
                </div>
            `;
        } else {
            return `
                <div class="asset-item" onclick="copyUrl('${item.url}')">
                    <div class="asset-thumb"><img src="${item.url}" loading="lazy" onerror="this.parentElement.innerHTML='üñºÔ∏è'"></div>
                    <div class="asset-name">${item.name}</div>
                </div>
            `;
        }
    }).join('');
}

// Copy URL to clipboard
function copyUrl(url) {
    navigator.clipboard.writeText(url).then(() => {
        showToast('URL copied to clipboard!');
    }).catch(err => {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = url;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showToast('URL copied to clipboard!');
    });
}

// Show toast notification
function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
}

// Init
loadConfig();
updateSourceUI();
</script>

<div class="disco-modal-overlay" id="discoModalOverlay" onclick="if(event.target===this)discoCloseModal()"><div class="disco-modal"><div class="disco-modal-title">Disco says:</div><div class="disco-modal-msg" id="discoModalMsg"></div><div class="disco-modal-btns" id="discoModalBtns"></div></div></div>
<script>
function discoAlert(msg,cb){var o=document.getElementById('discoModalOverlay'),m=document.getElementById('discoModalMsg'),b=document.getElementById('discoModalBtns');m.textContent=typeof msg==='string'?msg:String(msg);b.innerHTML='<button class="disco-btn-primary" onclick="discoCloseModal(\'ok\')">OK</button>';o.classList.add('active');window._discoCb=cb||null;window._discoOk=null;window._discoCancel=null;}
function discoConfirm(msg,onOk,onCancel){var o=document.getElementById('discoModalOverlay'),m=document.getElementById('discoModalMsg'),b=document.getElementById('discoModalBtns');m.textContent=typeof msg==='string'?msg:String(msg);b.innerHTML='<button class="disco-btn-secondary" onclick="discoCloseModal(\'cancel\')">Cancel</button><button class="disco-btn-primary" onclick="discoCloseModal(\'ok\')">OK</button>';o.classList.add('active');window._discoOk=onOk||null;window._discoCancel=onCancel||null;window._discoCb=null;}
function discoStackSend(){var o=document.getElementById('discoModalOverlay'),m=document.getElementById('discoModalMsg'),b=document.getElementById('discoModalBtns');m.textContent='Sent to Stack Builder!';b.innerHTML='<button class="disco-btn-secondary" onclick="discoCloseModal(\'cancel\')">Close</button><button class="disco-btn-primary" onclick="discoCloseModal(\'ok\')">Open Stack Builder now</button>';o.classList.add('active');window._discoOk=function(){window.location.href='stack-builder-clean.html';};window._discoCancel=null;window._discoCb=null;}
function discoCloseModal(action){document.getElementById('discoModalOverlay').classList.remove('active');if(action==='ok'&&window._discoOk){var f=window._discoOk;window._discoOk=null;f();}else if(action==='cancel'&&window._discoCancel){var f=window._discoCancel;window._discoCancel=null;f();}else if(action==='ok'&&window._discoCb){var f=window._discoCb;window._discoCb=null;f();}}
</script>
</body>
</html>
