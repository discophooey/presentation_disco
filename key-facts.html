<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scrolltastic Key Facts Panel</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f0f0f; color: #e0e0e0; }
.app { display: flex; height: 100vh; }
.controls { width: 360px; background: #1a1a1a; overflow-y: auto; padding: 20px; border-right: 1px solid #2a2a2a; flex-shrink: 0; }
.preview-wrap { flex: 1; display: flex; flex-direction: column; }
.preview-header { padding: 10px 20px; background: #1a1a1a; border-bottom: 1px solid #2a2a2a; display: flex; justify-content: space-between; align-items: center; }
.preview-header span { color: #888; font-size: 12px; }
#progressDisplay { color: #4a9eff; font-weight: bold; }
.preview-scroll { flex: 1; overflow-y: auto; background: #0a0a0a; }
.preview-container { min-height: 300vh; position: relative; display: flex; align-items: center; justify-content: center; }
.preview-stage { position: sticky; top: 50px; width: 100%; max-width: 600px; padding: 20px; }
.preview-panel { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px; padding: 30px; }
.preview-panel-title { font-size: 14px; color: #4a9eff; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; opacity: 0; transform: translateY(10px); transition: all 0.4s; }
.preview-panel-title.on { opacity: 1; transform: translateY(0); }
.preview-fact { display: flex; gap: 12px; padding: 16px 0; border-bottom: 1px solid #2a2a2a; opacity: 0; transform: translateX(-20px); transition: all 0.4s; }
.preview-fact:last-child { border-bottom: none; }
.preview-fact.on { opacity: 1; transform: translateX(0); }
.preview-fact-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0; }
.preview-fact-text { font-size: 15px; line-height: 1.5; color: #ccc; }
.preview-source { font-size: 12px; color: #666; margin-top: 20px; padding-top: 16px; border-top: 1px solid #2a2a2a; opacity: 0; transition: all 0.4s; }
.preview-source.on { opacity: 1; }

h1 { font-size: 18px; color: #4a9eff; margin-bottom: 20px; }
h2 { font-size: 11px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px; padding: 10px 0; border-bottom: 1px solid #2a2a2a; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
h2::after { content: '‚ñº'; font-size: 8px; transition: transform 0.2s; }
h2.collapsed::after { transform: rotate(-90deg); }
.section { overflow: hidden; transition: max-height 0.3s; }
.section.collapsed { max-height: 0 !important; }
.control-group { margin-bottom: 12px; }
.control-group label { display: block; font-size: 11px; color: #888; margin-bottom: 4px; }
.control-group input[type="text"], .control-group input[type="number"], .control-group select, .control-group textarea { width: 100%; padding: 8px 10px; background: #0a0a0a; border: 1px solid #333; color: #fff; border-radius: 4px; font-size: 13px; }
.control-group input[type="color"] { width: 50px; height: 32px; border: none; background: none; cursor: pointer; }
.control-group input[type="range"] { width: 100%; }
.inline-group { display: flex; gap: 10px; align-items: center; }
.inline-group > * { flex: 1; }
button { padding: 10px 16px; background: #4a9eff; border: none; color: #000; font-weight: 600; border-radius: 6px; cursor: pointer; font-size: 13px; width: 100%; margin-top: 8px; }
button:hover { background: #357abd; }
button.secondary { background: #2a2a2a; color: #888; }
button.secondary:hover { background: #333; color: #fff; }
button.danger { background: #c0392b; color: #fff; }
button.danger:hover { background: #e74c3c; }

.facts-list { background: #0a0a0a; border-radius: 6px; padding: 10px; margin: 10px 0; max-height: 250px; overflow-y: auto; }
.fact-item { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 6px; padding: 10px; margin-bottom: 8px; cursor: pointer; transition: border-color 0.2s; }
.fact-item:hover { border-color: #4a9eff; }
.fact-item.selected { border-color: #4a9eff; background: #1a2a3a; }
.fact-item .fact-text { font-size: 12px; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
.modal.active { display: flex; }
.modal-content { background: #1a1a1a; border-radius: 12px; padding: 24px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; border: 1px solid #2a2a2a; }
.modal-content h3 { color: #4a9eff; margin-bottom: 16px; }
.modal-content textarea { height: 200px; font-family: monospace; font-size: 11px; }
.modal-actions { display: flex; gap: 10px; margin-top: 16px; }
.modal-actions button { flex: 1; }
</style>
</head>
<body>
<div class="app">
    <div class="controls">
        <h1>üìã Key Facts Panel</h1>
        
        <h2 onclick="toggleSection(this)">Panel Content</h2>
        <div class="section">
            <div class="control-group">
                <label>Panel Title</label>
                <input type="text" id="panelTitle" value="What You Need to Know" oninput="updatePreview()">
            </div>
            <div class="control-group">
                <label>Source Attribution</label>
                <input type="text" id="sourceText" placeholder="Source: Reuters, 2024" oninput="updatePreview()">
            </div>
        </div>
        
        <h2 onclick="toggleSection(this)">Facts</h2>
        <div class="section">
            <div class="facts-list" id="factsList"></div>
            <button onclick="addFact()">+ Add Fact</button>
        </div>
        
        <div id="factEditor" style="display:none;">
            <h2 onclick="toggleSection(this)">Edit Fact</h2>
            <div class="section">
                <div class="control-group">
                    <label>Fact Text</label>
                    <textarea id="factText" rows="2" oninput="updateFact()"></textarea>
                </div>
                <div class="control-group">
                    <label>Icon</label>
                    <select id="factIcon" onchange="updateFact()">
                        <option value="‚Ä¢">‚Ä¢ Bullet</option>
                        <option value="‚Üí">‚Üí Arrow</option>
                        <option value="‚úì">‚úì Check</option>
                        <option value="!">! Alert</option>
                        <option value="?">? Question</option>
                        <option value="‚òÖ">‚òÖ Star</option>
                        <option value="1">1 Number</option>
                    </select>
                </div>
                <button class="danger" onclick="deleteFact()">Delete Fact</button>
            </div>
        </div>
        
        <h2 onclick="toggleSection(this)">Style</h2>
        <div class="section">
            <div class="control-group">
                <label>Accent Color</label>
                <input type="color" id="accentColor" value="#4a9eff" onchange="updatePreview()">
            </div>
            <div class="control-group">
                <label>Panel Background</label>
                <input type="color" id="panelBg" value="#1a1a1a" onchange="updatePreview()">
            </div>
            <div class="control-group">
                <label>Border Color</label>
                <input type="color" id="borderColor" value="#2a2a2a" onchange="updatePreview()">
            </div>
            <div class="control-group">
                <label>Stagger Delay (ms)</label>
                <input type="range" id="staggerDelay" min="50" max="300" value="100" oninput="updatePreview()">
            </div>
        </div>
        
        <h2 onclick="toggleSection(this)">Layout</h2>
        <div class="section">
            <div class="control-group">
                <label>Scroll Duration (%)</label>
                <input type="range" id="scrollDuration" min="100" max="300" value="150" oninput="updatePreviewHeight()">
            </div>
            <div class="control-group">
                <label>Max Width (px)</label>
                <input type="number" id="maxWidth" value="600" min="300" max="900" oninput="updatePreview()">
            </div>
            <div class="inline-group">
                <div class="control-group">
                    <label>Desktop Offset (px)</label>
                    <input type="number" id="desktopOffset" value="50" min="0" max="200">
                </div>
                <div class="control-group">
                    <label>Mobile Offset (px)</label>
                    <input type="number" id="mobileOffset" value="200" min="0" max="300">
                </div>
            </div>
        </div>
        
        <button onclick="generateExport()">Generate HTML</button>
    </div>
    
    <div class="preview-wrap">
        <div class="preview-header">
            <span>Preview (scroll to animate)</span>
            <span id="progressDisplay">0%</span>
        </div>
        <div class="preview-scroll" id="previewScroll">
            <div class="preview-container" id="previewContainer">
                <div class="preview-stage" id="previewStage">
                    <div class="preview-panel" id="previewPanel">
                        <div class="preview-panel-title" id="previewTitle"></div>
                        <div id="previewFacts"></div>
                        <div class="preview-source" id="previewSource"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal" id="exportModal">
    <div class="modal-content">
        <h3>Export HTML</h3>
        <div class="control-group">
            <label>Generated Code</label>
            <textarea id="exportCode" readonly></textarea>
        </div>
        <div class="modal-actions">
            <button onclick="copyCode()">üìã Copy</button>
            <button onclick="downloadCode()">‚¨áÔ∏è Download</button>
            <button onclick="sendToStackBuilder()">üìö Stack</button>
            <button class="secondary" onclick="closeModal()">Close</button>
        </div>
    </div>
</div>

<script>
var facts = [];
var selectedFactIndex = -1;

function toggleSection(el) {
    el.classList.toggle('collapsed');
    el.nextElementSibling.classList.toggle('collapsed');
}

function renderFactsList() {
    var html = '';
    facts.forEach(function(f, i) {
        html += '<div class="fact-item ' + (i === selectedFactIndex ? 'selected' : '') + '" onclick="selectFact(' + i + ')">';
        html += '<div class="fact-text">' + f.icon + ' ' + (f.text || '(empty)') + '</div>';
        html += '</div>';
    });
    document.getElementById('factsList').innerHTML = html || '<div style="color:#666;font-size:12px;text-align:center;padding:20px;">No facts yet. Add one!</div>';
}

function addFact() {
    facts.push({ text: 'Key fact goes here', icon: '‚Ä¢' });
    selectedFactIndex = facts.length - 1;
    renderFactsList();
    loadFactEditor();
    updatePreview();
    saveState();
}

function selectFact(i) {
    selectedFactIndex = i;
    renderFactsList();
    loadFactEditor();
}

function loadFactEditor() {
    if (selectedFactIndex < 0 || selectedFactIndex >= facts.length) {
        document.getElementById('factEditor').style.display = 'none';
        return;
    }
    document.getElementById('factEditor').style.display = 'block';
    var f = facts[selectedFactIndex];
    document.getElementById('factText').value = f.text;
    document.getElementById('factIcon').value = f.icon;
}

function updateFact() {
    if (selectedFactIndex < 0) return;
    facts[selectedFactIndex].text = document.getElementById('factText').value;
    facts[selectedFactIndex].icon = document.getElementById('factIcon').value;
    renderFactsList();
    updatePreview();
    saveState();
}

function deleteFact() {
    if (selectedFactIndex < 0) return;
    if (!confirm('Delete this fact?')) return;
    facts.splice(selectedFactIndex, 1);
    selectedFactIndex = Math.min(selectedFactIndex, facts.length - 1);
    renderFactsList();
    loadFactEditor();
    updatePreview();
    saveState();
}

function updatePreviewHeight() {
    var dur = parseInt(document.getElementById('scrollDuration').value) || 150;
    document.getElementById('previewContainer').style.height = dur + 'vh';
}

function updatePreview() {
    var panel = document.getElementById('previewPanel');
    var title = document.getElementById('previewTitle');
    var factsEl = document.getElementById('previewFacts');
    var source = document.getElementById('previewSource');
    var stage = document.getElementById('previewStage');
    
    var panelTitle = document.getElementById('panelTitle').value;
    var sourceText = document.getElementById('sourceText').value;
    var accentColor = document.getElementById('accentColor').value;
    var panelBg = document.getElementById('panelBg').value;
    var borderColor = document.getElementById('borderColor').value;
    var maxWidth = document.getElementById('maxWidth').value;
    var stagger = parseInt(document.getElementById('staggerDelay').value);
    
    title.textContent = panelTitle;
    title.style.color = accentColor;
    source.textContent = sourceText;
    source.style.display = sourceText ? 'block' : 'none';
    panel.style.background = panelBg;
    panel.style.borderColor = borderColor;
    stage.style.maxWidth = maxWidth + 'px';
    
    var factsHTML = '';
    facts.forEach(function(f, i) {
        factsHTML += '<div class="preview-fact" data-index="' + i + '" style="transition-delay:' + (i * stagger) + 'ms">';
        factsHTML += '<div class="preview-fact-icon" style="background:' + accentColor + ';color:#000">' + f.icon + '</div>';
        factsHTML += '<div class="preview-fact-text">' + f.text + '</div>';
        factsHTML += '</div>';
    });
    factsEl.innerHTML = factsHTML;
    
    checkScroll();
    saveState();
}

function checkScroll() {
    var scroll = document.getElementById('previewScroll');
    var container = document.getElementById('previewContainer');
    var scrollTop = scroll.scrollTop;
    var maxScroll = container.offsetHeight - scroll.clientHeight;
    var progress = maxScroll > 0 ? scrollTop / maxScroll : 0;
    
    document.getElementById('progressDisplay').textContent = Math.round(progress * 100) + '%';
    
    var title = document.getElementById('previewTitle');
    var factEls = document.querySelectorAll('.preview-fact');
    var source = document.getElementById('previewSource');
    
    if (progress > 0.1) {
        title.classList.add('on');
        factEls.forEach(function(el, i) {
            if (progress > 0.15 + (i * 0.05)) {
                el.classList.add('on');
            } else {
                el.classList.remove('on');
            }
        });
        if (progress > 0.15 + (facts.length * 0.05)) {
            source.classList.add('on');
        } else {
            source.classList.remove('on');
        }
    } else {
        title.classList.remove('on');
        factEls.forEach(function(el) { el.classList.remove('on'); });
        source.classList.remove('on');
    }
}

document.getElementById('previewScroll').addEventListener('scroll', checkScroll);

function generateExport() {
    if (facts.length === 0) { alert('Add at least one fact'); return; }
    
    var uid = 'kf' + Math.random().toString(36).substr(2, 9);
    var panelTitle = document.getElementById('panelTitle').value;
    var sourceText = document.getElementById('sourceText').value;
    var accentColor = document.getElementById('accentColor').value;
    var panelBg = document.getElementById('panelBg').value;
    var borderColor = document.getElementById('borderColor').value;
    var maxWidth = document.getElementById('maxWidth').value;
    var stagger = parseInt(document.getElementById('staggerDelay').value);
    var scrollMult = parseInt(document.getElementById('scrollDuration').value) / 100;
    var desktopOffset = document.getElementById('desktopOffset').value;
    var mobileOffset = document.getElementById('mobileOffset').value;
    
    var factsHTML = '';
    facts.forEach(function(f, i) {
        factsHTML += '<div class="kf-fact" style="transition-delay:' + (i * stagger) + 'ms">';
        factsHTML += '<div class="kf-icon">' + f.icon + '</div>';
        factsHTML += '<div class="kf-text">' + f.text + '</div>';
        factsHTML += '</div>\n';
    });
    
    var code = '<style>\n' +
'#' + uid + '{position:relative;background:#0a0a0a;display:flex;align-items:center;justify-content:center}\n' +
'#' + uid + ' .kf-stage{position:sticky;top:' + desktopOffset + 'px;width:100%;max-width:' + maxWidth + 'px;padding:20px}\n' +
'#' + uid + ' .kf-panel{background:' + panelBg + ';border:1px solid ' + borderColor + ';border-radius:12px;padding:30px}\n' +
'#' + uid + ' .kf-title{font-size:14px;color:' + accentColor + ';text-transform:uppercase;letter-spacing:2px;margin-bottom:20px;opacity:0;transform:translateY(10px);transition:all 0.4s}\n' +
'#' + uid + '.on .kf-title{opacity:1;transform:translateY(0)}\n' +
'#' + uid + ' .kf-fact{display:flex;gap:12px;padding:16px 0;border-bottom:1px solid ' + borderColor + ';opacity:0;transform:translateX(-20px);transition:all 0.4s}\n' +
'#' + uid + ' .kf-fact:last-child{border-bottom:none}\n' +
'#' + uid + '.on .kf-fact{opacity:1;transform:translateX(0)}\n' +
'#' + uid + ' .kf-icon{width:24px;height:24px;background:' + accentColor + ';border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;color:#000;flex-shrink:0}\n' +
'#' + uid + ' .kf-text{font-size:15px;line-height:1.5;color:#ccc}\n' +
'#' + uid + ' .kf-source{font-size:12px;color:#666;margin-top:20px;padding-top:16px;border-top:1px solid ' + borderColor + ';opacity:0;transition:all 0.4s}\n' +
'#' + uid + '.on .kf-source{opacity:1}\n' +
'@media(max-width:768px){#' + uid + ' .kf-stage{top:' + mobileOffset + 'px;padding:10px}#' + uid + ' .kf-panel{padding:20px}}\n' +
'</style>\n' +
'<div id="' + uid + '">\n' +
'<div class="kf-stage">\n' +
'<div class="kf-panel">\n' +
'<div class="kf-title">' + panelTitle + '</div>\n' +
factsHTML +
(sourceText ? '<div class="kf-source">' + sourceText + '</div>\n' : '') +
'</div>\n' +
'</div>\n' +
'</div>\n' +
'<scr' + 'ipt>\n' +
'(function(){\n' +
'var w=document.getElementById("' + uid + '");\n' +
'var scrollMult=' + scrollMult + ';\n' +
'function setH(){w.style.height=(w.querySelector(".kf-stage").offsetHeight*scrollMult)+"px";}\n' +
'setH();window.addEventListener("resize",setH);\n' +
'function upd(){\n' +
'var extP=window.SCROLLTASTIC_PROGRESS&&window.SCROLLTASTIC_PROGRESS["' + uid + '"];\n' +
'var progress;\n' +
'if(extP!==undefined){progress=extP;}else{\n' +
'var r=w.getBoundingClientRect();\n' +
'var scrolled=Math.max(0,-r.top);\n' +
'var range=w.offsetHeight-window.innerHeight;\n' +
'progress=range>0?scrolled/range:0;\n' +
'}\n' +
'if(progress>0.1)w.classList.add("on");else w.classList.remove("on");\n' +
'requestAnimationFrame(upd);\n' +
'}\n' +
'upd();\n' +
'})();\n' +
'<\/scr' + 'ipt>';
    
    document.getElementById('exportCode').value = code;
    document.getElementById('exportModal').classList.add('active');
}

function closeModal() { document.getElementById('exportModal').classList.remove('active'); }

function copyCode() {
    var code = document.getElementById('exportCode');
    code.select();
    document.execCommand('copy');
    alert('Copied!');
}

function downloadCode() {
    var code = document.getElementById('exportCode').value;
    var filename = prompt('Save as:', 'key-facts');
    if (!filename) return;
    var blob = new Blob([code], { type: 'text/html' });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename.replace(/[^a-z0-9_-]/gi, '_') + '.html';
    a.click();
}

function sendToStackBuilder() {
    var code = document.getElementById('exportCode').value;
    if (!code) { alert('Generate HTML first'); return; }
    var queue = JSON.parse(localStorage.getItem('disco_stack_queue') || '[]');
    queue.push({ name: 'Key Facts Panel', html: code, timestamp: Date.now() });
    localStorage.setItem('disco_stack_queue', JSON.stringify(queue));
    if (confirm('Sent to Stack Builder!\n\nOpen Stack Builder now?')) {
        window.location.href = 'stack-builder-clean.html';
    }
}

function saveState() {
    localStorage.setItem('disco_key-facts', JSON.stringify({
        facts: facts,
        panelTitle: document.getElementById('panelTitle').value,
        sourceText: document.getElementById('sourceText').value,
        accentColor: document.getElementById('accentColor').value,
        panelBg: document.getElementById('panelBg').value,
        borderColor: document.getElementById('borderColor').value,
        maxWidth: document.getElementById('maxWidth').value,
        staggerDelay: document.getElementById('staggerDelay').value,
        scrollDuration: document.getElementById('scrollDuration').value,
        desktopOffset: document.getElementById('desktopOffset').value,
        mobileOffset: document.getElementById('mobileOffset').value
    }));
}

function loadState() {
    var saved = localStorage.getItem('disco_key-facts');
    if (saved) {
        var s = JSON.parse(saved);
        facts = s.facts || [];
        document.getElementById('panelTitle').value = s.panelTitle || 'What You Need to Know';
        document.getElementById('sourceText').value = s.sourceText || '';
        document.getElementById('accentColor').value = s.accentColor || '#4a9eff';
        document.getElementById('panelBg').value = s.panelBg || '#1a1a1a';
        document.getElementById('borderColor').value = s.borderColor || '#2a2a2a';
        document.getElementById('maxWidth').value = s.maxWidth || 600;
        document.getElementById('staggerDelay').value = s.staggerDelay || 100;
        document.getElementById('scrollDuration').value = s.scrollDuration || 150;
        document.getElementById('desktopOffset').value = s.desktopOffset || 50;
        document.getElementById('mobileOffset').value = s.mobileOffset || 200;
    }
    renderFactsList();
    updatePreviewHeight();
    updatePreview();
}

loadState();
</script>
</body>
</html>
