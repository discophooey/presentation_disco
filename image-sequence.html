<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image Sequence Export | Scrolltastic</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f0f0f; color: #e0e0e0; min-height: 100vh; }
.container { display: flex; height: 100vh; }
.controls { width: 380px; background: #1a1a1a; padding: 20px; overflow-y: auto; border-right: 1px solid #2a2a2a; flex-shrink: 0; }
.preview-area { flex: 1; display: flex; flex-direction: column; background: #0a0a0a; }
h1 { font-size: 20px; margin-bottom: 8px; color: #fff; }
.subtitle { font-size: 12px; color: #666; margin-bottom: 24px; }
h2 { font-size: 14px; color: #4a9eff; margin: 24px 0 16px 0; text-transform: uppercase; letter-spacing: 1px; }
h2:first-of-type { margin-top: 0; }
.control-group { margin-bottom: 16px; }
.control-group label { display: block; font-size: 12px; color: #888; margin-bottom: 6px; }
.control-group input, .control-group select, .control-group textarea { width: 100%; padding: 10px 12px; background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 6px; color: #e0e0e0; font-size: 14px; }
.control-group textarea { min-height: 120px; font-family: monospace; font-size: 12px; resize: vertical; }
.control-group input:focus, .control-group select:focus, .control-group textarea:focus { outline: none; border-color: #4a9eff; }
button { padding: 10px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; transition: all 0.2s; }
button.primary { background: #4a9eff; color: #000; font-weight: 600; }
button.primary:hover { background: #6bb3ff; }
button.primary:disabled { background: #333; color: #666; cursor: not-allowed; }
button.secondary { background: #2a2a2a; color: #e0e0e0; }
button.secondary:hover { background: #3a3a3a; }

.radio-group { display: flex; gap: 8px; flex-wrap: wrap; }
.radio-group label { display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 6px; cursor: pointer; font-size: 13px; color: #ccc; }
.radio-group input { display: none; }
.radio-group input:checked + span { color: #4a9eff; }
.radio-group label:has(input:checked) { border-color: #4a9eff; background: #4a9eff11; }

.preview-header { padding: 12px 20px; background: #1a1a1a; border-bottom: 1px solid #2a2a2a; display: flex; align-items: center; gap: 16px; }
.preview-header span { font-size: 12px; color: #666; }
.preview-container { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; overflow: hidden; min-height: 400px; }
.preview-frame { background: #000; position: relative; overflow: hidden; min-width: 200px; min-height: 112px; }
.preview-frame iframe { border: none; transform-origin: top left; display: block; background: #000; }

.progress-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; flex-direction: column; }
.progress-overlay.active { display: flex; }
.progress-box { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px; padding: 40px; text-align: center; max-width: 400px; }
.progress-title { font-size: 18px; color: #fff; margin-bottom: 8px; }
.progress-status { font-size: 14px; color: #888; margin-bottom: 24px; }
.progress-bar { width: 300px; height: 8px; background: #2a2a2a; border-radius: 4px; overflow: hidden; }
.progress-fill { height: 100%; background: #4a9eff; width: 0%; transition: width 0.1s; }
.progress-percent { font-size: 24px; color: #4a9eff; margin-top: 16px; font-weight: 600; }
.progress-cancel { margin-top: 24px; }

.status-msg { padding: 12px; border-radius: 6px; font-size: 13px; margin-top: 16px; }
.status-msg.error { background: #ff4a4a22; border: 1px solid #ff4a4a44; color: #ff6b6b; }
.status-msg.success { background: #4aff4a22; border: 1px solid #4aff4a44; color: #6bff6b; }
.status-msg.info { background: #4a9eff22; border: 1px solid #4a9eff44; color: #6bb3ff; }

.specs { font-size: 11px; color: #666; margin-top: 8px; padding: 8px; background: #0a0a0a; border-radius: 4px; }
.specs span { color: #888; }

.ready-badge { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; background: #4aff4a22; border: 1px solid #4aff4a44; border-radius: 6px; font-size: 13px; color: #6bff6b; margin-bottom: 16px; }
.ready-badge::before { content: '✓'; }

.tip { font-size: 11px; color: #888; margin-top: 12px; padding: 10px; background: #0a0a0a; border-radius: 4px; border-left: 2px solid #4a9eff; line-height: 1.5; }
</style>
</head>
<body>

<div id="disco-nav" style="position:fixed;top:0;left:0;right:0;z-index:99999;background:#111;border-bottom:1px solid #2a2a2a;display:flex;overflow-x:auto;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;">
    <a href="index.html" style="padding:12px 20px;color:#4a9eff;text-decoration:none;font-size:14px;white-space:nowrap;border-right:1px solid #2a2a2a;">← Hub</a>
    <span style="padding:12px 20px;color:#fff;font-size:14px;font-weight:600;">Image Sequence Export</span>
</div>

<div class="container" style="padding-top:45px;">
    <div class="controls">
        <h1>Image Sequence</h1>
        <p class="subtitle">Export scroll stories as PNG frames</p>
        
        <div class="ready-badge">Ready to export</div>
        
        <h2>Source</h2>
        <div class="control-group">
            <label>Paste Exported HTML</label>
            <textarea id="htmlInput" placeholder="Paste your exported module or stack HTML here..."></textarea>
        </div>
        <button class="primary" onclick="loadPreview()" style="width:100%;">Load Preview</button>
        
        <h2>Export Settings</h2>
        <div class="control-group">
            <label>Aspect Ratio</label>
            <div class="radio-group">
                <label><input type="radio" name="aspect" value="16:9" checked><span>16:9</span></label>
                <label><input type="radio" name="aspect" value="9:16"><span>9:16</span></label>
                <label><input type="radio" name="aspect" value="1:1"><span>1:1</span></label>
            </div>
            <div class="specs">
                <span id="dimensionDisplay">1920 × 1080</span>
            </div>
        </div>
        
        <div class="control-group">
            <label>Duration</label>
            <div class="radio-group">
                <label><input type="radio" name="duration" value="10" checked><span>10s</span></label>
                <label><input type="radio" name="duration" value="15"><span>15s</span></label>
                <label><input type="radio" name="duration" value="20"><span>20s</span></label>
            </div>
        </div>
        
        <div class="control-group">
            <label>Frame Rate</label>
            <div class="radio-group">
                <label><input type="radio" name="fps" value="24"><span>24</span></label>
                <label><input type="radio" name="fps" value="25"><span>25</span></label>
                <label><input type="radio" name="fps" value="30" checked><span>30</span></label>
            </div>
            <div class="specs">
                <span id="frameDisplay">300 frames total</span>
            </div>
        </div>
        
        <div class="control-group">
            <label>Scroll Easing</label>
            <select id="easing">
                <option value="linear">Linear (constant speed)</option>
                <option value="easeInOut" selected>Ease In/Out (smooth start/stop)</option>
                <option value="easeIn">Ease In (slow start)</option>
                <option value="easeOut">Ease Out (slow end)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>File Prefix</label>
            <input type="text" id="filePrefix" value="frame" placeholder="frame">
            <div class="specs">Output: <span id="filenamePreview">frame_0001.png</span></div>
        </div>
        
        <div id="statusArea"></div>
        
        <button class="primary" id="renderBtn" onclick="startRender()" disabled style="width:100%;margin-top:24px;padding:14px;">
            Export Image Sequence
        </button>
        
        <div class="tip">
            <strong>DaVinci Resolve:</strong> File → Import → Media, select first frame, check "Image Sequence"<br><br>
            <strong>After Effects:</strong> File → Import → File, select first frame, check "PNG Sequence"
        </div>
    </div>
    
    <div class="preview-area">
        <div class="preview-header">
            <span>Preview</span>
            <span id="previewInfo">No content loaded</span>
        </div>
        <div class="preview-container" id="previewContainer">
            <div class="preview-frame" id="previewFrame" style="width:480px;height:270px;">
                <iframe id="previewIframe" style="width:1920px;height:1080px;transform:scale(0.25);transform-origin:top left;border:none;background:#000;"></iframe>
            </div>
        </div>
    </div>
</div>

<div class="progress-overlay" id="progressOverlay">
    <div class="progress-box">
        <div class="progress-title">Exporting Frames</div>
        <div class="progress-status" id="progressStatus">Preparing...</div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="progress-percent" id="progressPercent">0%</div>
        <button class="secondary progress-cancel" onclick="cancelRender()">Cancel</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
var rendering = false;
var cancelRequested = false;
var loadedHTML = '';

function getSettings() {
    var aspect = document.querySelector('input[name="aspect"]:checked').value;
    var duration = parseInt(document.querySelector('input[name="duration"]:checked').value);
    var fps = parseInt(document.querySelector('input[name="fps"]:checked').value);
    var easing = document.getElementById('easing').value;
    var prefix = document.getElementById('filePrefix').value || 'frame';
    
    var width, height;
    if (aspect === '16:9') { width = 1920; height = 1080; }
    else if (aspect === '9:16') { width = 1080; height = 1920; }
    else { width = 1080; height = 1080; }
    
    return { aspect: aspect, duration: duration, fps: fps, easing: easing, prefix: prefix, width: width, height: height, totalFrames: duration * fps };
}

function updateDisplays() {
    var s = getSettings();
    document.getElementById('dimensionDisplay').textContent = s.width + ' × ' + s.height;
    document.getElementById('frameDisplay').textContent = s.totalFrames + ' frames total';
    document.getElementById('filenamePreview').textContent = s.prefix + '_0001.png';
    updatePreviewSize();
}

document.querySelectorAll('input[name="aspect"], input[name="duration"], input[name="fps"]').forEach(function(el) {
    el.addEventListener('change', updateDisplays);
});
document.getElementById('filePrefix').addEventListener('input', updateDisplays);

function loadPreview() {
    var html = document.getElementById('htmlInput').value.trim();
    if (!html) {
        showStatus('error', 'Paste some HTML first');
        return;
    }
    
    loadedHTML = html;
    
    var frame = document.getElementById('previewFrame');
    frame.innerHTML = '';
    
    var iframe = document.createElement('iframe');
    iframe.id = 'previewIframe';
    iframe.style.cssText = 'border:none;background:#000;display:block;';
    frame.appendChild(iframe);
    
    iframe.srcdoc = html;
    
    setTimeout(function() {
        updatePreviewSize();
        document.getElementById('previewInfo').textContent = 'Content loaded';
        document.getElementById('renderBtn').disabled = false;
        showStatus('success', 'Preview loaded. Ready to export.');
    }, 300);
}

function updatePreviewSize() {
    var s = getSettings();
    var container = document.getElementById('previewContainer');
    var frame = document.getElementById('previewFrame');
    var iframe = frame.querySelector('iframe') || document.getElementById('previewIframe');
    
    if (!iframe) return;
    
    var containerRect = container.getBoundingClientRect();
    var maxW = containerRect.width - 40;
    var maxH = containerRect.height - 40;
    
    if (maxW <= 0 || maxH <= 0) return;
    
    var scaleW = maxW / s.width;
    var scaleH = maxH / s.height;
    var scale = Math.min(scaleW, scaleH, 1);
    
    var displayW = Math.floor(s.width * scale);
    var displayH = Math.floor(s.height * scale);
    
    frame.style.width = displayW + 'px';
    frame.style.height = displayH + 'px';
    frame.style.overflow = 'hidden';
    
    iframe.style.width = s.width + 'px';
    iframe.style.height = s.height + 'px';
    iframe.style.transform = 'scale(' + scale + ')';
    iframe.style.transformOrigin = 'top left';
    iframe.style.display = 'block';
}

var easings = {
    linear: function(t) { return t; },
    easeIn: function(t) { return t * t; },
    easeOut: function(t) { return t * (2 - t); },
    easeInOut: function(t) { return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t; }
};

async function startRender() {
    if (!loadedHTML || rendering) return;
    
    rendering = true;
    cancelRequested = false;
    
    var s = getSettings();
    var overlay = document.getElementById('progressOverlay');
    overlay.classList.add('active');
    
    document.getElementById('progressFill').style.width = '0%';
    document.getElementById('progressPercent').textContent = '0%';
    document.getElementById('progressStatus').textContent = 'Preparing...';
    
    try {
        var renderFrame = document.createElement('iframe');
        renderFrame.style.cssText = 'position:fixed;left:-9999px;top:0;width:' + s.width + 'px;height:' + s.height + 'px;border:none;background:#000;';
        document.body.appendChild(renderFrame);
        
        renderFrame.srcdoc = loadedHTML;
        await new Promise(function(r) { setTimeout(r, 1500); });
        
        var renderDoc = renderFrame.contentDocument || renderFrame.contentWindow.document;
        var renderBody = renderDoc.body;
        
        var scrollHeight = Math.max(
            renderDoc.documentElement.scrollHeight,
            renderBody.scrollHeight
        ) - s.height;
        
        var zip = new JSZip();
        var ease = easings[s.easing];
        
        for (var i = 0; i < s.totalFrames; i++) {
            if (cancelRequested) throw new Error('Cancelled');
            
            var progress = i / (s.totalFrames - 1);
            var easedProgress = ease(progress);
            var scrollPos = Math.round(easedProgress * scrollHeight);
            
            renderFrame.contentWindow.scrollTo(0, scrollPos);
            await new Promise(function(r) { setTimeout(r, 50); });
            
            var canvas = await html2canvas(renderBody, {
                width: s.width,
                height: s.height,
                windowWidth: s.width,
                windowHeight: s.height,
                scrollX: 0,
                scrollY: scrollPos,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#000000',
                scale: 1
            });
            
            var dataUrl = canvas.toDataURL('image/png');
            var base64 = dataUrl.split(',')[1];
            
            var frameNum = String(i + 1).padStart(4, '0');
            zip.file(s.prefix + '_' + frameNum + '.png', base64, {base64: true});
            
            var pct = Math.round(((i + 1) / s.totalFrames) * 90);
            document.getElementById('progressFill').style.width = pct + '%';
            document.getElementById('progressPercent').textContent = pct + '%';
            document.getElementById('progressStatus').textContent = 'Capturing frame ' + (i + 1) + ' of ' + s.totalFrames;
        }
        
        document.body.removeChild(renderFrame);
        
        if (cancelRequested) throw new Error('Cancelled');
        
        document.getElementById('progressStatus').textContent = 'Creating ZIP...';
        document.getElementById('progressFill').style.width = '95%';
        document.getElementById('progressPercent').textContent = '95%';
        
        var content = await zip.generateAsync({type: 'blob'});
        
        var downloadUrl = URL.createObjectURL(content);
        var a = document.createElement('a');
        a.href = downloadUrl;
        a.download = s.prefix + '_' + s.width + 'x' + s.height + '_' + s.fps + 'fps.zip';
        a.click();
        URL.revokeObjectURL(downloadUrl);
        
        document.getElementById('progressFill').style.width = '100%';
        document.getElementById('progressPercent').textContent = '100%';
        
        overlay.classList.remove('active');
        showStatus('success', 'Exported ' + s.totalFrames + ' frames! Import as image sequence.');
        
    } catch (err) {
        console.error('Render error:', err);
        overlay.classList.remove('active');
        if (err.message !== 'Cancelled') {
            showStatus('error', 'Export failed: ' + err.message);
        }
    }
    
    rendering = false;
}

function cancelRender() {
    cancelRequested = true;
    document.getElementById('progressStatus').textContent = 'Cancelling...';
}

function showStatus(type, msg) {
    var area = document.getElementById('statusArea');
    area.innerHTML = '<div class="status-msg ' + type + '">' + msg + '</div>';
    if (type === 'success') {
        setTimeout(function() { area.innerHTML = ''; }, 8000);
    }
}

window.addEventListener('resize', updatePreviewSize);

updateDisplays();
setTimeout(updatePreviewSize, 100);
</script>
</body>
</html>
